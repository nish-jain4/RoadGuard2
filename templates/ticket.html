<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ticket Details - QuickDesk</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #4e73df;
      --primary-hover: #3a5ec0;
      --success-color: #1cc88a;
      --danger-color: #e74a3b;
      --warning-color: #f6c23e;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f8f9fc;
    }
    
    .ticket-header {
      border-left: 4px solid var(--primary-color);
      padding-left: 1rem;
    }
    
    .status-badge {
      font-weight: 600;
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      font-size: 0.75rem;
    }
    
    .status-open {
      background-color: rgba(78, 115, 223, 0.1);
      color: var(--primary-color);
    }
    
    .status-in-progress {
      background-color: rgba(246, 194, 62, 0.1);
      color: var(--warning-color);
    }
    
    .status-resolved {
      background-color: rgba(28, 200, 138, 0.1);
      color: var(--success-color);
    }
    
    .status-closed {
      background-color: rgba(231, 74, 59, 0.1);
      color: var(--danger-color);
    }
    
    .priority-high {
      color: var(--danger-color);
      font-weight: bold;
    }
    
    .priority-medium {
      color: var(--warning-color);
      font-weight: bold;
    }
    
    .priority-low {
      color: var(--success-color);
      font-weight: bold;
    }
    
    .message-user {
      background-color: #f1f1f1;
      border-radius: 1rem 1rem 1rem 0;
    }
    
    .message-agent {
      background-color: var(--primary-color);
      color: white;
      border-radius: 1rem 1rem 0 1rem;
    }
    
    .message-admin {
      background-color: var(--danger-color);
      color: white;
      border-radius: 1rem 1rem 0 1rem;
    }
    
    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand navbar-light bg-white shadow-sm">
    <div class="container">
      <a class="navbar-brand" href="#">
        <i class="fas fa-ticket-alt text-primary me-2"></i>
        <span class="font-weight-bold">QuickDesk</span>
      </a>
      <div class="d-flex align-items-center">
        <span class="me-3 d-none d-sm-inline">Ticket #<span id="ticket-id"></span></span>
        <button class="btn btn-outline-secondary" onclick="window.history.back()">
          <i class="fas fa-arrow-left me-1"></i> Back
        </button>
      </div>
    </div>
  </nav>

  <div class="container my-5">
    <div class="card shadow">
      <div class="card-header bg-white">
        <div class="d-flex justify-content-between align-items-center">
          <h4 class="ticket-header mb-0" id="ticket-subject"></h4>
          <div>
            <span class="status-badge me-2" id="ticket-status-badge"></span>
            <span class="badge bg-light text-dark" id="ticket-priority"></span>
          </div>
        </div>
      </div>
      
      <div class="card-body">
        <div class="row mb-4">
          <div class="col-md-6">
            <p><strong>Category:</strong> <span id="ticket-category"></span></p>
            <p><strong>Created By:</strong> <span id="ticket-created-by"></span></p>
            <p><strong>Created:</strong> <span id="ticket-created-at"></span></p>
          </div>
          <div class="col-md-6">
            <p><strong>Assigned To:</strong> <span id="ticket-assigned-to"></span></p>
            <p><strong>Last Updated:</strong> <span id="ticket-updated-at"></span></p>
            <p><strong>Replies:</strong> <span id="ticket-replies-count"></span></p>
          </div>
        </div>
        
        <div class="card mb-4">
          <div class="card-header bg-light">
            <h6 class="mb-0">Description</h6>
          </div>
          <div class="card-body">
            <p id="ticket-description" class="mb-0"></p>
          </div>
        </div>
        
        <h5 class="mb-3">Conversation</h5>
        <div id="ticket-thread" class="mb-4">
          <!-- Messages will be loaded here -->
        </div>
        
        <div class="card">
          <div class="card-header bg-light">
            <h6 class="mb-0">Add Reply</h6>
          </div>
          <div class="card-body">
            <textarea id="reply-box" class="form-control mb-3" rows="4" placeholder="Type your reply here..."></textarea>
            <div class="d-flex justify-content-between">
              <div>
                <label for="attachment" class="btn btn-outline-secondary btn-sm">
                  <i class="fas fa-paperclip"></i> Attach File
                  <input type="file" id="attachment" style="display: none;">
                </label>
                <span id="file-name" class="ms-2 small text-muted"></span>
              </div>
              <div>
                <button class="btn btn-primary me-2" onclick="addReply()">
                  <i class="fas fa-paper-plane me-1"></i> Send Reply
                </button>
                <div class="btn-group">
                  <button type="button" class="btn btn-outline-success dropdown-toggle" data-bs-toggle="dropdown">
                    Change Status
                  </button>
                  <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" onclick="changeStatus('Open')">Mark as Open</a></li>
                    <li><a class="dropdown-item" href="#" onclick="changeStatus('In Progress')">Mark as In Progress</a></li>
                    <li><a class="dropdown-item" href="#" onclick="changeStatus('Resolved')">Mark as Resolved</a></li>
                    <li><a class="dropdown-item" href="#" onclick="changeStatus('Closed')">Mark as Closed</a></li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Get ticket ID from URL
     const urlParams = new URLSearchParams(window.location.search);
     const ticketId = urlParams.get('id');
     let currentUser = JSON.parse(localStorage.getItem('currentUser')) || { email: 'guest@example.com', role: 'user' };
    
    // Load ticket data
     function loadTicket() {
      const tickets = JSON.parse(localStorage.getItem('tickets')) || [];
      const ticket = tickets.find(t => t.id === ticketId);
      
     if (!ticket) {
        alert('Ticket not found');
        window.location.href = currentUser.role === 'user' ? 'user-dashboard.html' : 
                             currentUser.role === 'agent' ? 'agent-dashboard.html' : 
                             'admin-dashboard.html';
        return;
      }
      
      // Display ticket info
      document.getElementById('ticket-id').textContent = ticketId;
      document.getElementById('ticket-subject').textContent = ticket.subject;
      document.getElementById('ticket-description').textContent = ticket.description;
      document.getElementById('ticket-category').textContent = ticket.category;
      document.getElementById('ticket-created-by').textContent = ticket.createdBy || 'Unknown';
      document.getElementById('ticket-assigned-to').textContent = ticket.assignedTo || 'Unassigned';
      document.getElementById('ticket-created-at').textContent = new Date(ticket.createdAt).toLocaleString();
      document.getElementById('ticket-updated-at').textContent = new Date(ticket.updatedAt).toLocaleString();
      document.getElementById('ticket-replies-count').textContent = ticket.thread ? ticket.thread.length : 0;
      
      // Set status badge
      const statusBadge = document.getElementById('ticket-status-badge');
      statusBadge.textContent = ticket.status;
      statusBadge.className = 'status-badge ';
      if (ticket.status === 'Open') statusBadge.classList.add('status-open');
      else if (ticket.status === 'In Progress') statusBadge.classList.add('status-in-progress');
      else if (ticket.status === 'Resolved') statusBadge.classList.add('status-resolved');
      else if (ticket.status === 'Closed') statusBadge.classList.add('status-closed');
      
      // Set priority badge
      const priorityBadge = document.getElementById('ticket-priority');
      priorityBadge.textContent = ticket.priority || 'Medium';
      if (ticket.priority === 'High') priorityBadge.classList.add('priority-high');
      else if (ticket.priority === 'Medium') priorityBadge.classList.add('priority-medium');
      else priorityBadge.classList.add('priority-low');
      
      // Load conversation thread
      const threadDiv = document.getElementById('ticket-thread');
      threadDiv.innerHTML = '';
      
      if (!ticket.thread || ticket.thread.length === 0) {
        threadDiv.innerHTML = '<div class="text-center py-4 text-muted">No messages yet</div>';
        return;
      }
      
      ticket.thread.forEach(msg => {
        const messageDiv = document.createElement('div');
        messageDiv.className = `d-flex mb-3 ${msg.by === 'You' || msg.by === currentUser.email ? 'justify-content-end' : ''}`;
        
        if (msg.by !== 'You' && msg.by !== currentUser.email) {
          messageDiv.innerHTML += `
            <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(msg.by.split('@')[0])}&background=${msg.role === 'admin' ? 'e74a3b' : msg.role === 'agent' ? '4e73df' : '6c757d'}&color=fff" 
                 class="avatar me-3" alt="${msg.by}">
          `;
        }
        
        messageDiv.innerHTML += `
          <div class="message-${msg.role === 'admin' ? 'admin' : msg.role === 'agent' ? 'agent' : 'user'} p-3" style="max-width: 70%;">
            <div class="d-flex justify-content-between small mb-2">
              <strong>${msg.by}</strong>
              <span>${new Date(msg.timestamp).toLocaleString()}</span>
            </div>
            <p class="mb-1">${msg.message}</p>
            ${msg.attachment ? `
            <div class="mt-2">
              <a href="#" class="text-${msg.role === 'user' ? 'primary' : 'white-50'}">
                <i class="fas fa-paperclip me-1"></i> ${msg.attachment}
              </a>
            </div>
            ` : ''}
          </div>
        `;
        
        if (msg.by === 'You' || msg.by === currentUser.email) {
          messageDiv.innerHTML += `
            <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.email.split('@')[0])}&background=4e73df&color=fff" 
                 class="avatar ms-3" alt="You">
          `;
        }
        
        threadDiv.appendChild(messageDiv);
      });
      
      // Scroll to bottom of thread
      threadDiv.scrollTop = threadDiv.scrollHeight;
    }
    
    // Add reply to ticket
    function addReply() {
      const replyText = document.getElementById('reply-box').value.trim();
      if (!replyText) {
        alert('Please enter a reply message');
        return;
      }
      
      const tickets = JSON.parse(localStorage.getItem('tickets')) || [];
      const ticketIndex = tickets.findIndex(t => t.id === ticketId);
      
      if (ticketIndex === -1) return;
      
      const newReply = {
        by: currentUser.email || 'You',
        message: replyText,
        role: currentUser.role || 'user',
        timestamp: new Date().toISOString()
      };
      
      // Handle attachment if any
      const attachmentInput = document.getElementById('attachment');
      if (attachmentInput.files.length > 0) {
        newReply.attachment = attachmentInput.files[0].name;
        // In a real app, you would upload the file here
      }
      
      if (!tickets[ticketIndex].thread) {
        tickets[ticketIndex].thread = [];
      }
      
      tickets[ticketIndex].thread.push(newReply);
      tickets[ticketIndex].updatedAt = new Date().toISOString();
      
      // If ticket was closed and someone replies, reopen it
      if (tickets[ticketIndex].status === 'Closed') {
        tickets[ticketIndex].status = 'Open';
      }
      
      localStorage.setItem('tickets', JSON.stringify(tickets));
      
      // Clear reply box and attachment
      document.getElementById('reply-box').value = '';
      document.getElementById('attachment').value = '';
      document.getElementById('file-name').textContent = '';
      
      // Reload ticket to show new reply
      loadTicket();
    }
    
    // Change ticket status
    function changeStatus(newStatus) {
      const tickets = JSON.parse(localStorage.getItem('tickets')) || [];
      const ticketIndex = tickets.findIndex(t => t.id === ticketId);
      
      if (ticketIndex === -1) return;
      
      tickets[ticketIndex].status = newStatus;
      tickets[ticketIndex].updatedAt = new Date().toISOString();
      localStorage.setItem('tickets', JSON.stringify(tickets));
      
      // Reload ticket to show new status
      loadTicket();
    }
    
    // Show selected file name
    document.getElementById('attachment').addEventListener('change', function() {
      const fileName = this.files.length > 0 ? this.files[0].name : '';
      document.getElementById('file-name').textContent = fileName;
    });
    
    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      // Check authentication
      if (!currentUser || !currentUser.email) {
        alert('Please login to view tickets');
        window.location.href = 'login.html';
        return;
      }
      
      loadTicket();
    });
  </script>
</body>
</html>